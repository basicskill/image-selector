{% extends 'admin/base.html' %}
{% block title %}Admin Dashboard{% endblock %}


{% block content%}
<!-- <h1>New image upload</h1>


<input type="file" id="file_input"/>
<p id="status">Please select a file</p>
<img id="preview"/>


<form method="POST" action="{{ url_for('admin.submit_form') }}">
    <input type="hidden" id="avatar-url" name="avatar-url">
    <input type="text" name="username" placeholder="Username">
    <input type="text" name="full-name" placeholder="Full name">
    <input type="submit" value="Update profile">
</form> -->

<h2>Upload new images</h2>
<form action="{{ url_for('admin.upload_images') }}" method=post enctype=multipart/form-data>
  <input type="file" class="form-control" name="images" id="images" multiple accept="image/*">
  <label for="classification">Upload images as:</label>
    <select class="form-select" name="classification" id="classification">
        <option value="unprocessed">Unprocessed</option>
        {% for classification in g.classes %}
        <option value="{{ classification }}">{{ classification }}</option>
        {% endfor %}
    </select>
    <br>
  <input type="submit" class="btn btn-primary" value="Upload">
</form>

<h2>Classes</h2>

<table>
    <tr>
        <th>Class name</th>
        <th>Count</th>
    </tr>
    {% for class in g.classes %}
        <tr>
            <td>{{ class }}</td>
            <td>{{ g.classes[class] }}</td>
            <td class="width-small">
                <form action="{{ url_for('admin.delete_classification', classification=class) }}" method="post">
                    <input class="danger" type="submit" value="Delete" onclick="return confirm('Are you sure?');">
                </form>
            </td>
        </tr>
    {% endfor %}
</table>
{% for class in g.unprocessed_classes %}
Number of images in <b>{{ class }}</b> folder is <b>{{ g.unprocessed_classes[class] }}</b>
<br>
{% endfor %}
</table>


<h3>Add new class</h3>
<form method="post" action="{{ url_for('admin.add_class') }}">
    <input class="form-control" name="new_class" id="new_class" required>
    <input type="submit" class="btn btn-primary" value="Add">
</form>

<h2>Uploaded images</h2>
<label for="classificationselect">Choose processing type:</label>
<form method=post enctype=select>
    <select class="form-select" name="processing" id="processing">
        <option value="all" {% if "all" == request.args.get('processing', 'all') %} selected {% endif %}>All</option>
        {% for class in config["STATES"] %}
        <option value="{{ class }}" {% if class == request.args.get('processing', 'all') %} selected {% endif %}>{{ class|capitalize }}</option>
        {% endfor %}
    </select>
    <br>
    <label for="classificationselect">Choose class:</label>
    <select class="form-select" name="classification" id="classification">
        <option value="all" {% if "all" == request.args.get('classification', 'all') %} selected {% endif %}>All</option>
        {% for classification in g.user['img_classes'] %}
        <option value="{{ classification }}" {% if classification == request.args.get('classification', 'all') %} selected {% endif %}>{{ classification }}</option>
        {% endfor %}
    </select>
    <br>
    <input type="submit" class="btn btn-secondary" value="Apply filters">
</form>


<table class="center">
    <tr>
        <th>Image</th>
        <th></th>
        <th>Status</th>
        <th>Class</th>
    </tr>
    {% for image in g.images %}
        <tr>
            <td><a href="{{ url_for('admin.edit_image', id=image['id'], processing=request.args.get('processing'), classification=request.args.get('classification'),
                page=curr_page) }}">
                <img src="{{ url_for('images.img_data', filename=image['filename']) }}"
                 alt="{{ image['filename'] }}"></td>
              </a>
            <td><a href="{{ url_for('admin.edit_image', id=image['id'], processing=request.args.get('processing'), classification=request.args.get('classification'),
                page=curr_page) }}">More details</a></td>
            <td>{{ image['processing'] }}</td>
            <td>{{ image['classification'] }}</td>
        </tr>
    {% endfor %}
</table>
<center>

    <a href="{{ url_for('admin.image_explorer', processing=request.args.get('processing'), classification=request.args.get('classification'),
                page=curr_page - 1) }}" class="btn btn-secondary">&laquo; Previous</a>
    <label for="page_number">{{ curr_page }} / {{ g.pages }}</label>
    <a href="{{ url_for('admin.image_explorer', processing=request.args.get('processing'), classification=request.args.get('classification'),
                page=curr_page + 1) }}" class="btn btn-secondary">Next &raquo;</a>

</center>
<!-- <script>
    (function() {
        document.getElementById("file_input").onchange = function(){
            var files = document.getElementById("file_input").files;
            var file = files[0];
            if(!file){
                return alert("No file selected.");
            }
            getSignedRequest(file);
        };
    })();
    // document.getElementById('file_input').addEventListener('change', () => {
    //     var files = document.getElementById("file_input").files;
    //     var file = files[0];
    //     if(!file){
    //         return alert("No file selected.");
    //     }
    //     getSignedRequest(file);
    // });
    function getSignedRequest(file){
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/images/sign_s3?file_name="+file.name+"&file_type="+file.type);
        xhr.onreadystatechange = function(){
            if(xhr.readyState === 4){
                if(xhr.status === 200){
                    var response = JSON.parse(xhr.responseText);
                    uploadFile(file, response.data, response.url);
                }
                else{
                    console.log(file.name);
                    alert("Could not get signed URL.");
                }
            }
        };
        xhr.send();
    };

    function uploadFile(file, s3Data, url){
        var xhr = new XMLHttpRequest();
        xhr.open("POST", s3Data.url);

        var postData = new FormData();
        for(key in s3Data.fields){
            postData.append(key, s3Data.fields[key]);
        }
        postData.append('file', file);

        xhr.onreadystatechange = function() {
            if(xhr.readyState === 4){
            if(xhr.status === 200 || xhr.status === 204){
                document.getElementById("preview").src = url;
            }
            else{
                alert("Could not upload file.");
            }
        }
        };
        xhr.send(postData);
    }
</script> -->

{% endblock %}
